<style>
    :root { --marine: #002e85; --ciel: #40B7FF; --noir: #1a1a1a; }
    .tax-calc-container {
        max-width: 750px; margin: 20px auto; font-family: 'Helvetica Neue', Arial, sans-serif;
        background: #ffffff; padding: 35px; border-top: 10px solid var(--marine);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .tax-calc-container h2 { color: var(--marine); text-align: center; margin-bottom: 30px; font-weight: 900; text-transform: uppercase; }
    .tax-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    label { display: block; font-weight: bold; font-size: 0.9rem; margin-bottom: 6px; color: var(--marine); }
    input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; color: var(--noir); }
    .checkbox-group { grid-column: span 2; display: flex; align-items: center; background: #f9f9f9; padding: 15px; border: 1px solid #ddd; }
    .checkbox-group input { width: auto; margin-right: 15px; transform: scale(1.4); }
    .btn-calc { width: 100%; background: var(--marine); color: white !important; border: none; padding: 22px; font-size: 1.3rem; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
    .btn-calc:hover { background: var(--ciel); }
    .tax-result { margin-top: 35px; padding: 30px; border: 4px solid var(--marine); display: none; background: #fff; }
    .tax-result h3 { color: var(--marine); border-bottom: 2px solid var(--ciel); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; }
    .tax-line { display: flex; justify-content: space-between; margin: 12px 0; font-weight: 600; color: var(--noir); border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .tax-line b { color: var(--marine); font-weight: 900; }
    .tax-total-line { border-top: 4px solid var(--marine); padding-top: 20px; font-weight: 900; font-size: 1.7rem; color: var(--marine) !important; border-bottom: none; }
</style>

<div class="tax-calc-container">
    <h2>Simulateur Fiscal Alpina Pro</h2>
    <div class="tax-grid">
        <div class="tax-form-group">
            <label>Année fiscale</label>
            <select id="f-annee">
                <option value="2026">2026</option><option value="2025" selected>2025</option>
                <option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option>
            </select>
        </div>
        <div class="tax-form-group">
            <label>Canton</label>
            <select id="f-canton">
                <option value="VD" selected>Vaud (VD)</option><option value="GE">Genève (GE)</option>
                <option value="VS">Valais (VS)</option><option value="FR">Fribourg (FR)</option>
                <option value="NE">Neuchâtel (NE)</option><option value="JU">Jura (JU)</option>
                <option value="BE">Berne (BE)</option>
            </select>
        </div>
    </div>
    <div class="tax-grid">
        <div class="tax-form-group">
            <label>Code Postal (NPA)</label>
            <input type="number" id="f-npa" placeholder="Ex: 1800" oninput="rechercheNPA()">
        </div>
        <div class="tax-form-group">
            <label>Commune détectée</label>
            <input type="text" id="f-ville-nom" readonly style="background:#f0f7ff; font-weight:bold;">
        </div>
    </div>
    <div class="tax-grid">
        <div class="tax-form-group">
            <label>État civil</label>
            <select id="f-statut">
                <option value="1">Célibataire / Divorcé(e)</option>
                <option value="2">Marié(e)</option>
                <option value="3">Famille monoparentale</option>
            </select>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="f-menage">
            <label for="f-menage" style="margin:0">Enfant(s) faisant ménage commun</label>
        </div>
    </div>
    <div class="tax-grid">
        <div><label>Revenu Imposable ICC</label><input type="number" id="f-rev-cc" value="100000"></div>
        <div><label>Revenu Imposable IFD</label><input type="number" id="f-rev-fed" value="100000"></div>
    </div>
    <div class="tax-grid">
        <div><label>Nombre d'enfants (Parts 1.0)</label><input type="number" id="f-enf-full" value="0"></div>
        <div><label>Nombre d'enfants (Parts 0.5)</label><input type="number" id="f-enf-half" value="0"></div>
    </div>
    <div class="tax-form-group"><label>Fortune Imposable</label><input type="number" id="f-fortune" value="0"></div>
    <button class="btn-calc" id="btn-submit" onclick="lancerCalcul()">Lancer la simulation</button>
    <div id="tax-result-area" class="tax-result">
        <h3>Détail Fiscal Professionnel</h3>
        <div class="tax-line">Impôt Fédéral Direct (IFD) : <b id="out-ifd"></b></div>
        <div class="tax-line">Impôt Cantonal : <b id="out-cant"></b></div>
        <div class="tax-line">Impôt Communal : <b id="out-comm"></b></div>
        <div class="tax-line tax-total-line">CHARGE FISCALE TOTALE : <b id="out-total"></b></div>
    </div>
</div>

<script>
const DB_VILLES = { "1800":"Vevey", "1000":"Lausanne", "1200":"Genève", "1700":"Fribourg", "1950":"Sion" };
function rechercheNPA() {
    const n = document.getElementById('f-npa').value;
    document.getElementById('f-ville-nom').value = DB_VILLES[n] || "NPA reconnu...";
}

async function lancerCalcul() {
    const btn = document.getElementById('btn-submit');
    btn.innerText = "Calcul en cours...";
    const payload = {
        taxYear: parseInt(document.getElementById('f-annee').value),
        canton: document.getElementById('f-canton').value,
        municipalityId: parseInt(document.getElementById('f-npa').value),
        maritalStatus: parseInt(document.getElementById('f-statut').value),
        income: parseFloat(document.getElementById('f-rev-fed').value),
        wealth: parseFloat(document.getElementById('f-fortune').value) || 0,
        numberOfChildren: parseInt(document.getElementById('f-enf-full').value)
    };
    try {
        const response = await fetch('/api/tax', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const r = await response.json();
        const f = new Intl.NumberFormat('fr-CH', { style: 'currency', currency: 'CHF' });
        document.getElementById('out-ifd').innerText = f.format(r.federalTax);
        document.getElementById('out-cant').innerText = f.format(r.cantonTax);
        document.getElementById('out-comm').innerText = f.format(r.municipalityTax);
        document.getElementById('out-total').innerText = f.format(r.totalTax);
        document.getElementById('tax-result-area').style.display = 'block';
    } catch (e) { alert("Erreur: Vérifiez les données ou le NPA."); }
    finally { btn.innerText = "Lancer la simulation"; }
}
</script>
